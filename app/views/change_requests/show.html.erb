  <% if notice %>
    <br>
    <div class='alert alert-success'>
       <p id="notice"><%= notice %></p>
    </div>
  <% end %>
<section class="content-header">
  <h1>
  Change Request 
    <% if @change_request.aasm_state == 'cancelled' || @change_request.aasm_state == 'rollbacked' || @change_request.aasm_state == 'rejected' %>
      <div class= "pull-right label label-danger" >
    <% elsif @change_request.aasm_state == 'deployed' %>
      <div class= "pull-right label label-success" >
    <% else %>
      <div class= "pull-right label  label-primary" >
    <% end %>
      <%=@change_request.aasm_state%></div>
  </h1>
</section>
<section class="content">
    <% if current_user.role=='approver' %>
    <div class='approve-status form-group'>
      <% if @approved == nil %>
       <%= link_to  approve_path(@change_request.id), data: { method: :put, confirm: 'Are you sure you want to approve this Change Request?' }, class: 'btn btn-success'  do %>
                                      <i class="fa fa-check fa-fw"></i>Approve
                                  <%end %> 
         <%= link_to  reject_path(@change_request.id), data: { method: :put, confirm: 'Are you sure you want to reject this Change Request?' }, class: 'btn btn-danger'  do %>
                                      <i class="fa fa-times fa-fw"></i>Reject
                                  <%end %> 
      <% elsif @approved %>
        <div class="label label-primary"> Approved by you </div>
      <% else %>
        <div class="label label-primary"> Rejected by you </div>
      <% end %>
    </div>
    <% end %>
      <% unless @change_request.closed? || current_user.role!='release_manager'%>
    <div class="box box-default">
        <div class="box-header with-border">
             <h3 class="box-title">Actions</h3>
        </div>
        <div class="box-body">
            <%= render 'status' %>
        </div>
    </div>
    <% end %>
    <div class='row'>
      <div class='col-lg-6 col-xs-12'>
        <div class="box box-default">
          <div class="box-header with-border">
            <h3 class="box-title">Change Summary</h3>
          </div>
          <div class="box-body">
            <%=raw @change_request.tag_list.map{ |t| link_to t, tag_path(t) }.join(', ')  %>
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th><strong>Requestor's name:</strong>
                  <%= @change_request.requestor_name %></th>

                  <th><strong>Request date:</strong>
                  <%= @change_request.created_at.to_s(:db) %></th>
                </tr>

                <tr>
                  <th colspan="2">
                    <div class="c1">
                      <h2><%= @change_request.change_summary %></h2>
                    </div>
                  </th>
                </tr>
              </thead>
            </table>
            <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Priority</th>

                <th>Category</th>

                <th>Type</th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td><%= @change_request.priority %></td>

                <td><%= @change_request.all_category %></td>

                <td><%= @change_request.all_type %></td>
              </tr>
            </tbody>
            </table>
            <h5>Change Requirement</h5>
            <div class="well well-sm">
              <%=raw @change_request.change_requirement%>
            </div>
            <h5>Bussines Justification</h5>
            <div class="well well-sm">
              <%=raw @change_request.business_justification %>
            </div>
            <h5>Requestor</h5>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Name</th>

                    <th>Position</th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%= @change_request.requestor_name %></td>

                    <td><%= @change_request.requestor_position %></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h5>Notes</h5>

            <div class="well well-sm">
              <%=raw @change_request.note %>
            </div>
          </div>
        </div>

        <div class='box box-default'>
          <div class='box-header with-border'>
            <h3 class='box-title'>Analysis Solution Impact</h3>
            <div class='box-body'>
              <h5>Analysis</h5>
              <div class="well well-sm">
                <%=raw @change_request.analysis %>
              </div>
              <h5>Solution</h5>
              <div class="well well-sm">
                <%=raw @change_request.solution %>
              </div>
              <h5>Impact</h5>
              <div class="well well-sm">
                <%=raw @change_request.impact %>
              </div>
              <strong>Scope:</strong> <%= @change_request.scope %>
            </div>
          </div>
        </div>

        <div class='box box-default'>
          <div class='box-header with-border'>
            <h3 class='box-title'>Design and Backup Plan </h3>
          </div>
          <div class='box-body'>
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Design:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.design %></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Backup:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.backup %></td>
                  </tr>
                </tbody>
              </table>
            </div>
             <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Definition of success:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.definition_of_success %></td>
                  </tr>
                </tbody>
              </table>
            </div>
             <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Definition of failed:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.definition_of_failed %></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6 col-xs-12">
        <div class='box box-default'>
          <div class='box-header with-border'>
            <h3 class='box-title'>Testing
            </h3>
          </div>
          <div class='box-body'>
            <p><strong>Testing environment available:</strong>
            <%= @change_request.testing_environment_available %></p>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Testing Procedure:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.testing_procedure %></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Name</th>

                    <th>position</th>
                  </tr>
                </thead>

                <tbody>
                  <% @change_request.testers.each do |tes| %>

                  <tr>
                    <td><%= tes.name %></td>

                    <td><%= tes.position %></td>
                  </tr><% end %>
                </tbody>
              </table>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Testing Notes:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.testing_notes %></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class='box box-default'>
          <div class='box-header with-border'>
            <h3 class='box-title'>Approval
            </h3>
          </div>
          <div class='box-body'>
            <h5>Approval:</h5>

            <p>After viewing the testing procedures and confirmed the testing result are
            positive, this CR has been confirmed appropiate to be deployed in production by
            :</p>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Position</th>
                    <th>Status </th>
                  </tr>
                </thead>
                <tbody>
                  <% @change_request.approvers.each do |app| %>
                  <tr>
                    <td><%= app.user.name %></td>
                    <td><%= app.user.position %></td>
                    <td><%if  app.approve == nil  %>
                      waiting for approval
                      <%elsif app.approve %>
                      approved
                      <%else%>
                      rejected
                      <%end %>
                    </td>
                  </tr><%end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class='box box-default'>
          <div class='box-header with-border'>
            <h3 class='box-title'>Implementation
            </h3>
          </div>
          <div class='box-body'>
            <h3>Implementation</h3>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th colspan="3">Schedule</th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><strong>Schedule Change</strong></td>

                    <td colspan="2"><%= @change_request.schedule_change_date %></td>
                  </tr>

                  <tr>
                    <td><strong>Planned Complation</strong></td>

                    <td colspan="2"><%= @change_request.planned_completion %></td>
                  </tr>

                  <tr>
                    <td><strong>Grace Period Starts</strong></td>

                    <td colspan="2"><%= @change_request.grace_period_starts %></td>
                  </tr>

                  <tr>
                    <td><strong>Grace Preiod Ends</strong></td>

                    <td colspan="2"><%= @change_request.grace_period_end %></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h5>Implementer</h5>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Name</th>

                    <th>position</th>
                  </tr>
                </thead>

                <tbody>
                  <% @change_request.implementers.each do |imp| %>

                  <tr>
                    <td><%= imp.name %></td>

                    <td><%= imp.position %></td>
                  </tr><% end %>
                </tbody>
              </table>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Implementer Notes:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.implementation_notes %></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover">
                <thead>
                  <tr>
                    <th><strong>Grace Notes:</strong></th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td><%=raw @change_request.grace_period_notes %></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>  
    </div>

    <div class='row'>
      <div class='col-lg-6 col-xs-12'>
        <div class="box box-default">
          <div class="box-header with-border">
            <i class="fa fa-comments fa-fw"></i>
            Comments
          </div>
          <!-- /.panel-heading -->
          <div class="box-body">
              <ul class="list-unstyled">
               <% @change_request.comments.each do |c| %>
                  <li class="left clearfix">
                      <div class="chat-body clearfix">
                          <div class="header">
                              <strong class="primary-font"><%= c.user.name %></strong>
                              <small class="pull-right text-muted">
                                  <i class="fa fa-clock-o fa-fw"></i> <%= c.created_at.to_s(:long) %>
                              </small>
                          </div>
                          <p>
                             <%= c.body %>
                          </p>
                      </div>
                  </li>
               <% end %>
              </ul>
          </div>
          <!-- /.panel-body -->
          <div class="box-footer">
              <div class="form-group">              
                 <%= form_for ([@change_request, @change_request.comments.build]) do |f| %>
                 <%= f.text_area :body, class:"form-control" %>
                <br>
                  <span class="input-group-btn">
                    <%= f.submit class:"btn btn-primary btn-flat"%>
                  </span>
                 <% end %>
              </div>
          </div>
          <!-- /.panel-footer -->
        </div>
      </div>
      <div class="col-lg-6 col-xs-12">
        <%= render 'version', document: @change_request %>
      </div>
    </div>

    
</section>

